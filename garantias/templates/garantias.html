{% extends "plantilla.html" %}

{% block head_scripts %}
  <!-- CSS DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
  <!-- jQuery (primero) -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <!-- DataTables -->
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
  <!-- Helper site (después de jQuery/DataTables) -->
  <script src="/static/js/funciones/dataTables.js"></script>
{% endblock %}

{# ====== Variables usadas por plantilla.html ====== #}
{% set titulo = "Gestión de Garantías" %}
{% set icono = "shield-check" %}

{% set tabs_view = true %}
{% set tabs2 = true %}
{% set tab1_icono = "cash-coin" %}
{% set tab1_nombre = "Garantías Ventas" %}
{% set tab2_icono = "tools" %}
{% set tab2_nombre = "Garantías Servicios" %}

{% set subtitulo2 = "Buscar Garantías Ventas" %}
{% set placeholder = "Buscar garantía venta..." %}

{% set subtitulo4 = "Buscar Garantías Servicios" %}
{% set placeholder3 = "Buscar garantía servicio..." %}

{% set btnRegistrar = false %}

{% set subtitulo = "Lista Garantías de Ventas" %}
{% set tabla_id = "tablaVentas" %}

{% set subtitulo3 = "Lista Garantías de Servicios" %}
{% set tabla_id2 = "tablaServicios" %}

{# ====== Encabezados de las dos tablas ====== #}
{% block columnas_tabla %}
<tr>
  <th>ID Garantía</th>
  <th>Cliente</th>
  <th>Producto</th>
  <th>Fecha de Inicio</th>
  <th>Fecha de Finalización</th>
  <th>Estado</th>
  <th>Descripción</th>
  <th>Acciones</th>
</tr>
{% endblock %}

{% block columnas_tabla2 %}
<tr>
  <th>ID Garantía</th>
  <th>Cliente</th>
  <th>Equipo</th>
  <th>Fecha de Inicio</th>
  <th>Fecha de Finalización</th>
  <th>Descripción</th>
</tr>
{% endblock %}

{# ====== Modales ====== #}
{% block modales %}
  <!-- Modal: Renovar Garantía (sólo ventas) -->
  <div class="modal fade" id="modalRenovar" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form id="formRenovar" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Renovar garantía</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="renovar_garantia_id">
          <div class="mb-2">
            <label class="form-label">Producto actual</label>
            <input type="text" id="renovar_producto_actual" class="form-control" disabled>
          </div>
          <div class="mb-2">
            <label class="form-label">ID producto nuevo (opcional)</label>
            <input type="number" id="renovar_id_producto_nuevo" class="form-control" placeholder="Deja vacío para mismo producto">
          </div>
          <div class="mb-2">
            <label class="form-label">Meses de garantía</label>
            <input type="number" id="renovar_meses" class="form-control" value="1" min="1">
          </div>
          <div class="mb-2">
            <label class="form-label">Fecha de inicio</label>
            <input type="date" id="renovar_fecha_inicio" class="form-control">
          </div>
          <div class="text-muted small">
            Si no especificas producto nuevo, se usa el mismo. Por defecto: 1 mes desde hoy.
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Crear garantía renovada</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </form>
    </div>
  </div>
{% endblock %}

{% block scripts %}
<script>
  // Evita handlers heredados en #buscador
  $(document).off('keypress', '#buscador');

  // ---------- TABLA: VENTAS ----------
  const columnasVentas = [
    { data: "id_garantia",  title: "ID Garantía" },
    { data: "cliente",      title: "Cliente" },
    { data: "producto",     title: "Producto" },
    { data: "fecha_inicio", title: "Fecha de Inicio" },
    { data: "fecha_fin",    title: "Fecha de Finalización" },
    { data: "estado",       title: "Estado",
      render: (data) => {
        const map = {
          activa:   '<span class="badge bg-success">Activa</span>',
          vencida:  '<span class="badge bg-warning text-dark">Vencida</span>',
          anulada:  '<span class="badge bg-danger">Anulada</span>',
          renovada: '<span class="badge bg-info text-dark">Renovada</span>'
        };
        return map[data] || (data ?? '—');
      }
    },
    { data: "descripcion",  title: "Descripción" },
    {
      data: null,
      title: "Acciones",
      orderable: false,
      render: (_, __, row) => `
        <div class="btn-group">
          <button class="btn btn-sm btn-outline-danger"
                  onclick="anularGarantia('producto', ${row.id_garantia})">
            Anular
          </button>
          <button class="btn btn-sm btn-outline-success"
                  onclick="abrirModalRenovar(${row.id_garantia}, '${(row.producto || '').replace(/'/g, '\\\'')}')">
            Renovar
          </button>
        </div>`
    }
  ];

  // ---------- TABLA: SERVICIOS ----------
  const columnasServicios = [
    { data: "id_garantia",  title: "ID Garantía" },
    { data: "cliente",      title: "Cliente" },
    { data: "equipo",       title: "Equipo" },
    { data: "fecha_inicio", title: "Fecha de Inicio" },
    { data: "fecha_fin",    title: "Fecha de Finalización" },
    { data: "descripcion",  title: "Descripción",
      render: (d) => d ? $('<div/>').text(d).html() : '<span class="text-muted">—</span>'
    }
  ];

  document.addEventListener("DOMContentLoaded", () => {
    // --- Ventas ---
    if (typeof inicializarDataTable === "function") {
      inicializarDataTable('tablaVentas', '/garantias/data/ventas', columnasVentas);
    } else {
      $('#tablaVentas').DataTable({
        ajax: { url:'/garantias/data/ventas', dataSrc:'' },
        columns: columnasVentas,
        destroy: true,
        language: {
          search: "Buscar:",
          lengthMenu: "Mostrar _MENU_ registros",
          info: "Mostrando _START_ a _END_ de _TOTAL_ registros",
          paginate: { first:"Primero", last:"Último", next:"Siguiente", previous:"Anterior" },
          zeroRecords: "No se encontraron resultados"
        }
      });
    }

    // --- Servicios ---
    const dtServicios = $('#tablaServicios').DataTable({
      ajax: {
        url: '/garantias/data/servicios',
        dataSrc: '',
        data: function (d) {
          const input = document.getElementById('buscador2');
          if (input && input.value.trim().length > 0) d.q = input.value.trim();
        }
      },
      columns: columnasServicios,
      destroy: true,
      language: {
        search: "Buscar:",
        lengthMenu: "Mostrar _MENU_ registros",
        info: "Mostrando _START_ a _END_ de _TOTAL_ registros",
        paginate: { first:"Primero", last:"Último", next:"Siguiente", previous:"Anterior" },
        zeroRecords: "No se encontraron resultados"
      }
    });

    // Buscar en Servicios con Enter si existe #buscador2
    $(document).on('keypress', '#buscador2', function(e) {
      if (e.which === 13) {
        dtServicios.ajax.reload();
      }
    });

    // Default fecha hoy en modal renovar
    const today = new Date().toISOString().slice(0,10);
    $('#renovar_fecha_inicio').val(today);
  });

  // ---------- ACCIONES ----------
  async function anularGarantia(tipo, idGarantia) {
    if (!confirm('¿Deseas anular esta garantía? Esta acción no se puede deshacer.')) return;

    try {
      const resp = await fetch(`/garantias/${encodeURIComponent(tipo)}/${idGarantia}/estado`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ estado: 'anulada' })
      });

      if (!resp.ok) {
        const msg = await resp.text();
        alert('No se pudo anular la garantía.\n' + msg);
        return;
      }

      if ($.fn.DataTable.isDataTable('#tablaVentas')) $('#tablaVentas').DataTable().ajax.reload(null, false);
      if ($.fn.DataTable.isDataTable('#tablaServicios')) $('#tablaServicios').DataTable().ajax.reload(null, false);
    } catch (e) {
      console.error(e);
      alert('Error de red al anular la garantía.');
    }
  }

  // Renovar (ventas)
  window.abrirModalRenovar = function(idGarantia, nombreProducto){
    $('#renovar_garantia_id').val(idGarantia);
    $('#renovar_producto_actual').val(nombreProducto || '');
    const today = new Date().toISOString().slice(0,10);
    $('#renovar_fecha_inicio').val(today);
    $('#modalRenovar').modal('show');
  };

  $('#formRenovar').on('submit', async function(e){
    e.preventDefault();
    const id = $('#renovar_garantia_id').val();
    const id_producto_nuevo = $('#renovar_id_producto_nuevo').val()
      ? parseInt($('#renovar_id_producto_nuevo').val(), 10)
      : null;
    const meses = parseInt($('#renovar_meses').val(), 10) || 1;
    const fecha_inicio = $('#renovar_fecha_inicio').val() || null;

    try {
      const resp = await fetch(`/garantias/producto/${id}/renovar`, {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ id_producto_nuevo, meses, fecha_inicio })
      });
      if (!resp.ok) {
        const msg = await resp.text();
        alert('No se pudo renovar la garantía.\n' + msg);
        return;
      }
      $('#modalRenovar').modal('hide');
      if ($.fn.DataTable.isDataTable('#tablaVentas')) $('#tablaVentas').DataTable().ajax.reload(null, false);
    } catch (err) {
      console.error(err);
      alert('Error de red al renovar la garantía.');
    }
  });
</script>
{% endblock %}
